<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mapa d'Ãºs del catalÃ </title>
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    #map {
      height: 100%;
    }
    .vote-buttons button {
      margin: 2px;
      padding: 4px 8px;
    }
    #legend {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      font-size: 14px;
      border-radius: 5px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      z-index: 1000;
    }
    #zoom-warning {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: #ffdddd;
      padding: 10px;
      font-size: 14px;
      border: 1px solid #dd4444;
      border-radius: 5px;
      display: none;
      z-index: 1000;
    }
    #install-button {
      position: absolute;
      bottom: 10px;
      right: 10px;
      padding: 10px;
      background: green;
      color: white;
      border: none;
      border-radius: 5px;
      display: none;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="legend">
    <b>Llegenda:</b><br/>
    ðŸŸ© CatalÃ  sempre<br/>
    ðŸŸ¨ A vegades<br/>
    ðŸŸ¥ Mai
  </div>
  <div id="zoom-warning">Fes zoom mÃ©s a prop per veure els establiments</div>
  <button id="install-button">InstalÂ·la l'app</button>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.6/dist/umd/supabase.min.js"></script>
  <script>
    // Supabase config
    const supabaseUrl = 'https://bwzpnsslanzyjnvhhxfc.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'; // la clau sencera aquÃ­
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    const map = L.map('map').setView([41.3851, 2.1734], 8);
    const establishments = {};
    let userPlaceId = 0;

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    map.locate({ setView: true, maxZoom: 15 });
    map.on('locationfound', function (e) {
      L.circleMarker(e.latlng, {
        radius: 8,
        color: 'blue',
        fillColor: '#30f',
        fillOpacity: 0.7
      })
        .addTo(map)
        .bindPopup("Ets aquÃ­")
        .openPopup();
    });

    map.on('locationerror', function () {
      alert("No s'ha pogut obtenir la teva ubicaciÃ³.");
    });

    function getColorFromVotes(votes) {
      if (!votes || votes.length === 0) return 'gray';
      const avg = votes.reduce((a, b) => a + b, 0) / votes.length;
      if (avg >= 1.5) return 'green';
      if (avg >= 0.6) return 'orange';
      return 'red';
    }

    function average(votes) {
      if (!votes || votes.length === 0) return 0;
      return votes.reduce((a, b) => a + b, 0) / votes.length;
    }

    async function loadSharedPlaces() {
      const { data, error } = await supabase.from('places').select('*');
      if (error) {
        console.error('Error carregant places:', error);
        return;
      }
      data.forEach(place => {
        const marker = L.circleMarker([place.lat, place.lon], {
          radius: 6,
          color: getColorFromVotes(place.votes),
          fillOpacity: 0.8
        }).addTo(map);

        marker.bindPopup(generatePopup(place));

        establishments[place.id] = {
          ...place,
          marker
        };
      });
    }

    function generatePopup(place) {
      return `
        <b>${place.name}</b><br/>
        <small>${place.votes.length} vot(s) â€” mitjana: ${average(place.votes).toFixed(1)}</small><br/>
        <div class="vote-buttons">
          <button onclick="vote('${place.id}', 2)">ðŸŸ© SÃ­</button>
          <button onclick="vote('${place.id}', 1)">ðŸŸ¨ A vegades</button>
          <button onclick="vote('${place.id}', 0)">ðŸŸ¥ Mai</button>
        </div>
      `;
    }

    async function saveSharedPlace(place) {
      const { error } = await supabase.from('places').insert([place]);
      if (error) console.error('Error desant place:', error);
    }

    async function updateVotes(id, votes) {
      const { error } = await supabase.from('places').update({ votes }).eq('id', id);
      if (error) console.error('Error actualitzant votacions:', error);
    }

    function addPlace(latlng, name) {
      const id = 'user_' + (userPlaceId++);
      const votes = [];
      const place = { id, name, lat: latlng.lat, lon: latlng.lng, votes };
      const marker = L.circleMarker(latlng, {
        radius: 6,
        color: getColorFromVotes(votes),
        fillOpacity: 0.8
      }).addTo(map);

      marker.bindPopup(generatePopup(place));
      place.marker = marker;
      establishments[id] = place;
      saveSharedPlace(place);
    }

    window.vote = function(id, value) {
      const est = establishments[id];
      est.votes.push(value);
      est.marker.setStyle({ color: getColorFromVotes(est.votes) });
      est.marker.setPopupContent(generatePopup(est));
      updateVotes(id, est.votes);
    }

    const zoomWarning = document.getElementById('zoom-warning');
    map.on('zoomend', () => {
      zoomWarning.style.display = map.getZoom() < 13 ? 'block' : 'none';
    });

    // InstalÂ·laciÃ³ PWA
    let deferredPrompt;
    const installButton = document.getElementById('install-button');
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installButton.style.display = 'block';
    });

    installButton.addEventListener('click', async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const result = await deferredPrompt.userChoice;
        if (result.outcome === 'accepted') {
          console.log('PWA instalÂ·lada');
        }
        deferredPrompt = null;
        installButton.style.display = 'none';
      }
    });

    loadSharedPlaces();
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(() => console.log('Service Worker registrat!'))
        .catch(err => console.error('Error al registrar el Service Worker:', err));
    }
  </script>
</body>
</html>
actualitzaciÃ³ supabase v1
